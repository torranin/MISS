<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <title>MISS</title>
    <style>
      body {
        font-family: "Sarabun", sans-serif;
        height: 100vh; /* กำหนดความสูงของ body */
      }
      .card {
        max-width: 400px; /* กำหนดความกว้างสูงสุด */
        width: 100%; /* ให้การ์ดมีความกว้างเต็มที่ */
      }
      .logo {
        width: 100%; /* ปรับขนาดโลโก้ให้เต็มความกว้าง */
        max-width: 200px; /* กำหนดความกว้างสูงสุดของโลโก้ */
        margin-bottom: 20px; /* เพิ่มระยะห่างด้านล่าง */
      }
      #error-message {
        display: none; /* ซ่อนข้อความผิดพลาดเริ่มต้น */
      }
    </style>
  </head>
  <body>
    <div class="d-flex align-items-center justify-content-center vh-100">
      <div class="card border-0">
        <div class="card-body">
          <div class="text-center">
            <img
              src="https://www.maewanghospital.go.th/img/logomaewanghospital.png"
              alt="logo"
              class="logo"
            />
            <h3>Maewang Hospital Information Smart System</h3>
            <h4>(MISS)</h4>
          </div>
          <div id="loginForm">
            <div class="mb-3">
              <!-- <label for="email" class="form-label">อีเมล</label> -->
              <input
                type="email"
                class="form-control"
                id="email"
                placeholder="กรุณากรอกอีเมล"
                required
              />
            </div>
            <div class="mb-3">
              <!-- <label for="password" class="form-label">รหัสผ่าน</label> -->
              <input
                type="password"
                class="form-control"
                id="password"
                placeholder="กรุณากรอกรหัสผ่าน"
                required
              />
            </div>
            <div class="text-center mt-3">
              <button class="btn btn-primary w-100" onclick="login()">
                เข้าสู่ระบบ
              </button>
            </div>
            <div id="error-message" class="text-danger mt-2"></div>
          </div>
        </div>
      </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>

    <script>
      // ฟังก์ชัน decode JWT ให้รองรับ Base64URL
      function parseJwt(token) {
        let base64Url = token.split(".")[1];
        let base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
        base64 = base64.padEnd(
          base64.length + ((4 - (base64.length % 4)) % 4),
          "="
        );
        return JSON.parse(atob(base64));
      }
      function login() {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        const errorMessage = document.getElementById("error-message");

        errorMessage.style.display = "none";
        errorMessage.innerText = "";

        if (!email || !password) {
          errorMessage.innerText = "กรุณากรอกอีเมลและรหัสผ่าน";
          errorMessage.style.display = "block";
          return;
        }

        axios
          .post("/api/auth/login", {
            email: email,
            password: password,
          })
          .then((response) => {
            if (response.data.status === "success") {
              localStorage.setItem("token", response.data.token);
              // เปลี่ยนหน้าโดยอิง job_position
              const payload = parseJwt(response.data.token);
              const jobPosition = payload.job_position;
              
                window.location.href = "/dashboard";
            } else {
              errorMessage.innerText = response.data.message;
              errorMessage.style.display = "block";
            }
          })
          .catch((error) => {
            errorMessage.innerText = "เกิดข้อผิดพลาดในการเข้าสู่ระบบ";
            errorMessage.style.display = "block";
            console.error(error);
          });
      }
    </script>
  </body>
</html>
