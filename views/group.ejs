<%- include('partials/header') %>

  <!-- Start ตารางข้อมูลกลุ่มงาน -->
  <div class="container mt-5">
    <div class="card border-0" style="width: 100%">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <h3 class="mb-4" style="font-weight: bold">หน่วยงานรับผิดชอบตัวชี้วัด</h3>
          <div class="d-flex justify-content-end mb-3">
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createWorkGroupModal">
              สร้างผู้รับผิดชอบ
            </button>
          </div>
        </div>
        <br />
        <table class="table" id="group-table">
          <thead>
            <tr>
              <th>ชื่อผู้รับผิดชอบ</th>
              <th>กลุ่มตัวชี้วัด</th>
              <th>สถานะ</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
  <!-- End ตารางข้อมูลกลุ่มงาน -->

  <!-- Start Modal สร้างผู้รับผิดชอบ -->
  <div class="modal fade" id="createWorkGroupModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-labelledby="createWorkGroupModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="createWorkGroupModalLabel">
            <span id="modalTitle">สร้างผู้รับผิดชอบ</span>
          </h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- <div class="form-group mb-3">
            <label for="group_type" class="form-label" style="font-weight: bold">กลุ่มตัวชี้วัด</label>
            <select class="form-control" id="group_type">
              <option value="">เลือกกลุ่มตัวชี้วัด</option>
              <option value="ตัวชี้วัดนโยบาย">ตัวชี้วัดนโยบาย</option>
              <option value="ตัวชี้วัดองค์กร">ตัวชี้วัดองค์กร</option>
              <option value="ตัวชี้วัดระบบงานสำคัญ">ตัวชี้วัดระบบงานสำคัญ</option>
              <option value="ตัวชี้วัดหน่วยงาน">ตัวชี้วัดหน่วยงาน</option>
              <option value="ตัวชี้วัด THIP">ตัวชี้วัด THIP</option>
              <option value="true">ตัวชี้วัดทีมนำ</option>
                <option value="true">ตัวชี้วัดนโยบาย</option>
                <option value="false">ตัวชี้วัดโรงพยาบาล</option>
            </select>
          </div> -->
          <div class="form-group mb-3">
            <label for="group_description" class="form-label" style="font-weight: bold">ตัวชี้วัด</label>
            <input type="text" class="form-control" id="work_group_name" placeholder="ตัวชี้วัด" />
          </div>
          <!-- <div class="form-group mb-3">
            <label for="work_group_name" class="form-label" style="font-weight: bold">ชื่อผู้รับผิดชอบ</label>
            <input type="text" class="form-control" id="work_group_name" placeholder="กรุณากรอกชื่อผู้รับผิดชอบ" />
          </div> -->
          <div class="form-group mb-3">
            <label for="group_name" class="form-label" style="font-weight: bold">User ผู้รับผิดชอบ</label>
            <input type="text" class="form-control" id="edit-group_name" placeholder="กรุณากรอกชื่อผู้รับผิดชอบ" />
          </div>
          <div class="form-group mb-3">
            <label for="group_description" class="form-label" style="font-weight: bold">คำอธิบาย</label>
            <textarea class="form-control" id="group_description" placeholder="กรุณากรอกคำอธิบาย" rows="2"></textarea>
          </div>
          <!-- <div class="form-group mb-3">
                <div class="form-check form-switch">
                  <label class="form-check-label" for="group_status" style="font-weight: bold">เปิด/ปิดกลุ่มงาน</label>
                  <input class="form-check-input" type="checkbox" role="switch" id="group_status" checked>
                </div>
            </div> -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" onclick="createGroup()">
            สร้างผู้รับผิดชอบ
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            ยกเลิก
          </button>
        </div>
      </div>
    </div>
  </div>
  <!-- End Modal สร้างตัวชี้วัด -->

  <!-- Start Modal แก้ไขตัวชี้วัด -->
  <div class="modal fade" id="editGroupModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-labelledby="editGroupModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="editGroupModalLabel">
            <span id="modalTitle">แก้ไขผู้รับผิดชอบ</span>
          </h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" class="form-control" id="edit-group-id" />
          <div class="form-group mb-3">
            <label for="edit-group_type" class="form-label" style="font-weight: bold">กลุ่มตัวชี้วัด</label>
            <select class="form-control" id="edit-group_type">
              <option value="">เลือกกลุ่มตัวชี้วัด</option>
              <option value="ตัวชี้วัดนโยบาย">ตัวชี้วัดนโยบาย</option>
              <option value="ตัวชี้วัดองค์กร">ตัวชี้วัดองค์กร</option>
              <option value="ตัวชี้วัดระบบงานสำคัญ">ตัวชี้วัดระบบงานสำคัญ</option>
              <option value="ตัวชี้วัดหน่วยงาน">ตัวชี้วัดหน่วยงาน</option>
              <option value="ตัวชี้วัด THIP">ตัวชี้วัด THIP</option>
            </select>
          </div>
          <div class="form-group mb-3">
            <label for="group_name" class="form-label" style="font-weight: bold">ชื่อผู้รับผิดชอบ</label>
            <input type="text" class="form-control" id="edit-group_name" placeholder="กรุณากรอกชื่อผู้รับผิดชอบ" />
          </div>
          <div class="form-group mb-3">
            <label for="group_description" class="form-label" style="font-weight: bold">คำอธิบาย</label>
            <textarea class="form-control" id="edit-group_description" placeholder="กรุณากรอกคำอธิบาย"
              rows="2"></textarea>
          </div>
          <div class="form-group mb-3">
            <div class="form-check form-switch">
              <label class="form-check-label" for="edit-group_status"
                style="font-weight: bold">เปิด/ปิดตัวชี้วัด</label>
              <input class="form-check-input" type="checkbox" role="switch" id="edit-group_status" ${group_status===true
                ? 'checked' : '' }>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" onclick="handleConfirmEditGroup()">
            บันทึกการแก้ไขผู้รับผิดชอบ
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            ยกเลิก
          </button>
        </div>
      </div>
    </div>
  </div>
  <!-- End Modal แก้ไขผู้รับผิดชอบ -->

  <!-- เรียกใช้ JavaScript libraries ตามลำดับ -->
  <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>

    $(document).ready(function () {
      getToken();

      // กำหนด active สำหรับเมนูด้านบน
      const fullPath = window.location.pathname;
      if (fullPath.includes("/dashboard")) {
        document
          .getElementById("dashboard")
          .classList.add("active", "btn-primary");
        document
          .getElementById("dashboard")
          .classList.remove("btn-primary-outline");
      } else if (fullPath.includes("/group")) {
        document
          .getElementById("Set up")
          .classList.add("active", "btn-primary");
        document
          .getElementById("Set up")
          .classList.remove("btn-primary-outline");
      }

      try {
        groupTable = $("#group-table").DataTable({
          language: {
            search: "ค้นหา:",
            lengthMenu: "แสดง _MENU_ รายการ",
            info: "แสดง _START_ ถึง _END_ จาก _TOTAL_ รายการ",
            infoEmpty: "แสดง 0 ถึง 0 จาก 0 รายการ",
            infoFiltered: "(กรองจากทั้งหมด _MAX_ รายการ)",
            paginate: {
              first: "หน้าแรก",
              last: "หน้าสุดท้าย",
              next: "ถัดไป",
              previous: "ก่อนหน้า",
            },
          },
          responsive: true,
          order: [[1, "asc"]],
        });

        // console.log("DataTable initialized successfully");
      } catch (error) {
        console.error("Failed to initialize DataTable:", error);
      }
    });

    // Start Check if token is valid
    function getToken() {
      const token = localStorage.getItem("token");
      if (!token) {
        window.location.href = "/";
      } else {
        axios
          .post("/api/auth/verify-user-by-token", {
            token: token,
          })
          .then((response) => {
            const result = response.data;
            if (result.status === "success") {
              localStorage.setItem("userInfo", JSON.stringify(result.user));
              getGroupReport(); // เรียกใช้ฟังก์ชันโหลดเอกสาร
            }
          })
          .catch((error) => {
            window.location.href = "/";
          });
      }
    }
    // End Check if token is valid

    function logout() {
      localStorage.removeItem("token");
      localStorage.removeItem("userInfo");
      window.location.href = "/";
    }

    function clearForm() {
      document.getElementById("work_group_name").value = "";
      document.getElementById("group_type").value = "";
      document.getElementById("group_description").value = "";
    }

    function createGroup() {
      const group_type = document.getElementById("group_type").value;
      const group_name = document.getElementById("work_group_name").value;
      const group_description = document.getElementById("group_description").value;

      if (!group_type) {
        Swal.fire({
          position: "center",
          icon: "warning",
          title: "กรุณาเลือกกลุ่มตัวชี้วัด",
          showConfirmButton: false,
          timer: 1500,
        });
        return;
      }

      const payload = {
        group_name: group_name,
        group_type: group_type,
        group_description: group_description,
      };

      axios
        .post("/api/group/create-group", payload)
        .then((response) => {
          const result = response.data;
          if (result.status === "success") {
            Swal.fire({
              position: "center",
              icon: "success",
              title: "ผู้รับผิดชอบถูกสร้างเรียบร้อย",
              showConfirmButton: false,
              timer: 1500,
            });
            getGroupReport();
            $("#createWorkGroupModal").modal("hide");
            clearForm();
          } else {
            Swal.fire({
              position: "center",
              icon: "error",
              title: "ผู้รับผิดชอบมีอยู่ในระบบแล้ว",
              showConfirmButton: false,
              timer: 1500,
            });
          }
        })
        .catch((error) => {
          console.log(error);
        });
    }

    function getGroupReport() {
      axios
        .get("/api/group/get-group-report")
        .then((response) => {
          const result = response.data;
          if (result.status === "success" && groupTable) {
            const groups = result.groups;
            groupTable.clear(); // Clear existing data

            if (groups.length === 0) {
              groupTable.draw(); // Redraw the empty table
              return;
            }

            groups.forEach((group) => {
              groupTable.row.add([
                group.group_name,
                group.group_type,
                group.group_status === true ? '<span class="badge bg-success">เปิดใช้งาน</span>' : '<span class="badge bg-danger">ปิดใช้งาน</span>',
                `<center>
                  <button class="btn btn-warning btn-sm" onclick="onEditGroup('${group._id}')">
                    <i class="fa-solid fa-pen-to-square" ></i>
                  </button>
                  <button class="btn btn-danger btn-sm" onclick="ConfirmDeleteGroup('${group._id}')">
                    <i class="fa-solid fa-trash" ></i>
                  </button>
                  </center>`,
              ]);
            });

            groupTable.draw(); // Redraw once all rows are added
          }
        })
        .catch((error) => {
          console.log(error);
        });
    }

    function onEditGroup(group_id) {
      axios
        .get(`/api/group/get-group-by-id/${group_id}`)
        .then((response) => {
          const result = response.data;
          if (result.status === "success") {
            const group = result.group;
            document.getElementById("edit-group-id").value = group._id;
            document.getElementById("edit-group_name").value = group.group_name;
            document.getElementById("edit-group_type").value = group.group_type;
            document.getElementById("edit-group_description").value = group.group_description;
            document.getElementById("edit-group_status").checked = group.group_status;
            $("#editGroupModal").modal("show");
          }
        })
        .catch((error) => {
          console.log(error);
        });
    }

    function handleConfirmEditGroup() {
      const group_id = document.getElementById("edit-group-id").value;
      const group_name = document.getElementById("edit-group_name").value;
      const group_type = document.getElementById("edit-group_type").value;
      const group_description = document.getElementById("edit-group_description").value;
      const group_status = document.getElementById("edit-group_status").checked;

      if (!group_type) {
        Swal.fire({
          position: "center",
          icon: "warning",
          title: "กรุณาเลือกกลุ่มตัวชี้วัด",
          showConfirmButton: false,
          timer: 1500,
        });
        return;
      }

      axios
        .post(`/api/group/update-group/${group_id}`, {
          group_name: group_name,
          group_type: group_type,
          group_description: group_description,
          group_status: group_status,
        })
        .then((response) => {
          const result = response.data;
          if (result.status === "success") {
            Swal.fire({
              position: "center",
              icon: "success",
              title: "ดำเนินการแก้ไขกลุ่มงานเรียบร้อย",
              showConfirmButton: false,
              timer: 1500,
            });

            getGroupReport();
            $("#editGroupModal").modal("hide");
          } else {
            Swal.fire({
              position: "center",
              icon: "error",
              title: "ดำเนินการแก้ไขกลุ่มงานไม่สำเร็จ",
              showConfirmButton: false,
              timer: 1500,
            });
          }
        });
    }

    function ConfirmDeleteGroup(group_id) {
      Swal.fire({
        title: 'คุณต้องการลบกลุ่มงานนี้หรือไม่?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'ยืนยันการลบ',
        cancelButtonText: 'ยกเลิก',
      }).then((result) => {
        if (result.isConfirmed) {
          handleConfirmDeleteGroup(group_id);
        }
      });
    }

    function handleConfirmDeleteGroup(group_id) {
      axios
        .post(`/api/group/delete-group/${group_id}`)
        .then((response) => {
          const result = response.data;
          if (result.status === "success") {
            Swal.fire({
              position: "center",
              icon: "success",
              title: "ดำเนินการลบกลุ่มงานเรียบร้อย",
              showConfirmButton: false,
              timer: 1500,
            });

            getGroupReport();
            $("#editGroupModal").modal("hide");
          } else {
            Swal.fire({
              position: "center",
              icon: "error",
              title: "ดำเนินการลบกลุ่มงานไม่สำเร็จ",
              showConfirmButton: false,
              timer: 1500,
            });
          }
        });
    }

    function redirectToLink(link) {
      window.location.href = link;
    }

  </script>
  </body>

  </html>