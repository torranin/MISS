<%- include('partials/header') %>

  <!-- Start ตารางข้อมูลกลุ่มงาน -->
  <div class="container mt-5">
    <div class="card border-0" style="width: 100%">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <h3 class="mb-4" style="font-weight: bold">ตารางข้อมูลตัวแปรพื้นฐาน</h3>
          <div class="d-flex justify-content-end mb-3">
            <button type="button" class="btn btn-primary" data-bs-toggle="modal"
              data-bs-target="#createBasicValueVariableModal">
              สร้างตัวแปรพื้นฐาน
            </button>
          </div>
        </div>
        <br />
        <table class="table" id="basicValueVariableTable">
          <thead>
            <tr>
              <th>ชื่อ</th>
              <th>ชื่อภาษาอังกฤษ</th>
              <th>คำอธิบาย</th>
              <th>สถานะ</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
  <!-- End ตารางข้อมูลตัวแปรพื้นฐาน -->

  <!-- Start Modal สร้างตัวแปรพื้นฐาน -->
  <div class="modal fade" id="createBasicValueVariableModal" data-bs-backdrop="static" data-bs-keyboard="false"
    tabindex="-1" aria-labelledby="createBasicValueVariableModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="createBasicValueVariableModalLabel">
            <span id="modalTitle">สร้างตัวแปรพื้นฐาน</span>
          </h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ปิด" tabindex="-1"></button>
        </div>
        <div class="modal-body">
          <div class="form-group mb-3">
            <label for="name" class="form-label" style="font-weight: bold">ชื่อ</label>
            <input type="text" class="form-control" id="name" placeholder="" />
          </div>
          <div class="form-group mb-3">
            <label for="name_eng" class="form-label" style="font-weight: bold">ชื่อภาษาอังกฤษ</label>
            <input type="text" class="form-control" id="name_eng" placeholder="" />
          </div>
          <div class="form-group mb-3">
            <label for="description" class="form-label" style="font-weight: bold">คำอธิบาย</label>
            <textarea class="form-control" id="description" placeholder="กรุณากรอกคำอธิบาย" rows="2"></textarea>
          </div>
          <div class="form-group mb-3">
            <label for="status" class="form-label" style="font-weight: bold">สถานะ</label>
            <select class="form-select" id="status" aria-label="Default select example">
              <option selected value="true">เปิดใช้งาน</option>
              <option value="false">ปิดใช้งาน</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" onclick="createBasicValueVariable()">
            สร้างตัวแปรพื้นฐาน
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            ยกเลิก
          </button>
        </div>
      </div>
    </div>
  </div>
  <!-- End Modal สร้างตัวแปรพื้นฐาน -->

  <!-- เพิ่ม modal แก้ไขตัวแปรพื้นฐาน -->
  <div class="modal fade" id="editBasicValueVariableModal" data-bs-backdrop="static" data-bs-keyboard="false"
    tabindex="-1" aria-labelledby="editBasicValueVariableModalLabel" aria-hidden="true">

    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="editBasicValueVariableModalLabel">
            <span id="editModalTitle">แก้ไขตัวแปรพื้นฐาน</span>
          </h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ปิด" tabindex="-1"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="_id" />
          <div class="form-group mb-3">
            <label for="edit_name" class="form-label" style="font-weight: bold">ชื่อ</label>
            <input type="text" class="form-control" id="edit_name" placeholder="" />
          </div>
          <div class="form-group mb-3">
            <label for="edit_name_eng" class="form-label" style="font-weight: bold">ชื่อภาษาอังกฤษ</label>
            <input type="text" class="form-control" id="edit_name_eng" placeholder="" />
          </div>
          <div class="form-group mb-3">
            <label for="edit_description" class="form-label" style="font-weight: bold">คำอธิบาย</label>
            <textarea class="form-control" id="edit_description" placeholder="กรุณากรอกคำอธิบาย" rows="2"></textarea>
          </div>
          <div class="form-group mb-3">
            <label for="edit_status" class="form-label" style="font-weight: bold">สถานะ</label>
            <select class="form-select" id="edit_status" aria-label="Default select example">
              <option selected value="true">เปิดใช้งาน</option>
              <option value="false">ปิดใช้งาน</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" onclick="updateBasicValueVariable()">
            บันทึกการแก้ไข
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            ยกเลิก
          </button>
        </div>
      </div>
    </div>
  </div>
  <!-- End Modal แก้ไขตัวแปรพื้นฐาน -->

  <!-- เรียกใช้ JavaScript libraries ตามลำดับ -->
  <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    let basicValueVariableTable;
    let basicValueVariablesCache = [];

    $(document).ready(function () {
      // Check Token and Load Function
      getToken();

      // กำหนด active สำหรับเมนูด้านบน
      const fullPath = window.location.pathname;
      if (fullPath.includes("/dashboard")) {
        document
          .getElementById("dashboard")
          .classList.add("active", "btn-primary");
        document
          .getElementById("dashboard")
          .classList.remove("btn-primary-outline");
      } else if (fullPath.includes("/agency")) {
        document
          .getElementById("Set up")
          .classList.add("active", "btn-primary");
        document
          .getElementById("Set up")
          .classList.remove("btn-primary-outline");
      }

      try {
        // เริ่มต้น DataTable
        basicValueVariableTable = $("#basicValueVariableTable").DataTable({
          language: {
            search: "ค้นหา:",
            lengthMenu: "แสดง _MENU_ รายการ",
            info: "แสดง _START_ ถึง _END_ จาก _TOTAL_ รายการ",
            infoEmpty: "แสดง 0 ถึง 0 จาก 0 รายการ",
            infoFiltered: "(กรองจากทั้งหมด _MAX_ รายการ)",
            paginate: {
              first: "หน้าแรก",
              last: "หน้าสุดท้าย",
              next: "ถัดไป",
              previous: "ก่อนหน้า",
            },
          },
          autoWidth: false,
          responsive: true,
          order: [[0, "asc"]],
          columnDefs: [
            // ขยายคอลัมน์ "ชื่อ"
            { targets: 0, width: "30%" },
            // ลดคอลัมน์สถานะ/ปุ่มให้แคบลงเล็กน้อยเพื่อชดเชย
            { targets: 3, width: "12%" },
            { targets: 4, width: "10%", orderable: false },
          ],
          columns: [
            { data: "name" },
            { data: "name_eng" },
            { data: "description" },
            { data: "status" },
            { data: "actions" },
          ],
        });

        // console.log("DataTable initialized successfully");
      } catch (error) {
        console.error("Failed to initialize DataTable:", error);
      }
      // เพิ่ม Event Listener สำหรับการค้นหา
      $("#search-button").click(function () {
        searchBasicValueVariable();
      });

      // เพิ่ม Event Listener สำหรับการกด Enter ในช่องค้นหา
      $("#search-basicValueVariable").keypress(function (e) {
        if (e.which === 13) {
          searchBasicValueVariable();
        }
      });
    });

    // Start Check if token is valid
    function getToken() {
      const token = localStorage.getItem("token");
      if (!token) {
        window.location.href = "/";
      } else {
        axios
          .post("/api/auth/verify-user-by-token", {
            token: token,
          })
          .then((response) => {
            const result = response.data;
            if (result.status === "success") {
              localStorage.setItem("userInfo", JSON.stringify(result.user));
              getBasicValueVariableReport(); // เรียกใช้ฟังก์ชันโหลดตัวแปรพื้นฐาน
            }
          })
          .catch((error) => {
            window.location.href = "/";
          });
      }
    }
    // End Check if token is valid

    function logout() {
      localStorage.removeItem("token");
      localStorage.removeItem("userInfo");
      window.location.href = "/";
    }

    function getBasicValueVariableReport() {
      axios
        .get("/api/basic-value-variable/get-basic-value-variable-report")
        .then((response) => {
          const result = response.data;
          if (result.status === "success") {
            const basicValueVariables = result.basicValueVariables;
            displayBasicValueVariable(basicValueVariables);
          }
        })
        .catch((error) => {
          console.log(error);
        });
    }

    function displayBasicValueVariable(basicValueVariables) {
      if (!basicValueVariableTable) return;

      basicValueVariablesCache = Array.isArray(basicValueVariables)
        ? basicValueVariables
        : [];

      const rows = (basicValueVariables || []).map((item) => {
        const isActive =
          item?.status === true || item?.status === "true" || item?.status === 1;

        return {
          name: item?.name ?? "",
          name_eng: item?.name_eng ?? "",
          description: item?.description ?? "",
          status: isActive
            ? '<span class="badge bg-success">เปิดใช้งาน</span>'
            : '<span class="badge bg-secondary">ปิดใช้งาน</span>',
          actions: `
            <center>
              <button class="btn btn-warning btn-sm" onclick="openEditBasicValueVariableModal('${item?._id || ""}')">
                <i class="fa-solid fa-pen-to-square"></i>
              </button>
              <button class="btn btn-danger btn-sm" onclick="deleteBasicValueVariable('${item?._id || ""}')">
                <i class="fas fa-trash"></i>
              </button>
            </center>
          `,
        };
      });

      basicValueVariableTable.clear();
      basicValueVariableTable.rows.add(rows);
      basicValueVariableTable.draw();
    }

    function createBasicValueVariable() {
      const name = document.getElementById("name").value;
      const name_eng = document.getElementById("name_eng").value;
      const description = document.getElementById("description").value;
      const status = document.getElementById("status").value === "true";
      const payload = {
        name: name,
        name_eng: name_eng,
        description: description,
        status: status,
      };


      axios
        .post("/api/basic-value-variable/create-basic-value-variable", payload)
        .then((response) => {
          const result = response.data;
          if (result.status === "success") {
            Swal.fire({
              icon: "success",
              title: "สร้างตัวแปรพื้นฐานสำเร็จ",
              showConfirmButton: false,
              timer: 1500,
            });
            clearForm();
            getBasicValueVariableReport();

            // ปิด modal
            $("#createBasicValueVariableModal").modal("hide");
            // ล้างฟอร์ม
            clearForm();
            // โหลดข้อมูลใหม่
            getBasicValueVariableReport();
          }
        })
        .catch((error) => {
          console.log(error);
          const message =
            error?.response?.data?.message ||
            error?.response?.data?.error ||
            "สร้างตัวแปรพื้นฐานไม่สำเร็จ";
          Swal.fire({
            icon: "error",
            title: "สร้างตัวแปรพื้นฐานไม่สำเร็จ",
            text: message,
          });
        });
    }

    function clearForm() {
      const basicValueIdEl = document.getElementById("basic_value_id");
      if (basicValueIdEl) basicValueIdEl.value = "";
      document.getElementById("name").value = "";
      document.getElementById("name_eng").value = "";
      document.getElementById("description").value = "";
      document.getElementById("status").value = "true";
    }

    function fillEditBasicValueVariableForm(basicValueVariable) {
      document.getElementById("_id").value = basicValueVariable?._id || "";
      document.getElementById("edit_name").value = basicValueVariable?.name ?? "";
      document.getElementById("edit_name_eng").value =
        basicValueVariable?.name_eng ?? "";
      document.getElementById("edit_description").value =
        basicValueVariable?.description ?? "";
      document.getElementById("edit_status").value =
        basicValueVariable?.status === true ||
        basicValueVariable?.status === "true" ||
        basicValueVariable?.status === 1
          ? "true"
          : "false";
    }

    // เมื่อกดปุ่มแก้ไขจากตาราง: นำข้อมูลไปใส่ input ใน modal
    function openEditBasicValueVariableModal(basicValueVariableId) {
      const found = basicValueVariablesCache.find(
        (x) => String(x?._id) === String(basicValueVariableId)
      );

      if (found) {
        fillEditBasicValueVariableForm(found);
        $("#editBasicValueVariableModal").modal("show");
        return;
      }

      // fallback: ถ้า cache ไม่มี (เช่น refresh/ตารางยังไม่โหลด) ให้ดึงจาก API
      axios
        .get(
          `/api/basic-value-variable/get-basic-value-variable-by-id/${basicValueVariableId}`
        )
        .then((response) => {
          const result = response.data;
          if (result.status === "success") {
            fillEditBasicValueVariableForm(result.basicValueVariable);
            $("#editBasicValueVariableModal").modal("show");
          } else {
            Swal.fire({
              icon: "error",
              title: "ไม่สามารถดึงข้อมูลตัวแปรพื้นฐานได้",
            });
          }
        })
        .catch((error) => {
          console.log(error);
          const message =
            error?.response?.data?.message ||
            error?.response?.data?.error ||
            "ไม่สามารถดึงข้อมูลตัวแปรพื้นฐานได้";
          Swal.fire({
            icon: "error",
            title: "ไม่สามารถดึงข้อมูลตัวแปรพื้นฐานได้",
            text: message,
          });
        });
    }

    function updateBasicValueVariable() {
      const basicValueVariableId = document.getElementById("_id").value;
      const payload = {
        name: document.getElementById("edit_name").value,
        name_eng: document.getElementById("edit_name_eng").value,
        description: document.getElementById("edit_description").value,
        status: document.getElementById("edit_status").value === "true",
      };

      axios
        .post(
          `/api/basic-value-variable/update-basic-value-variable/${basicValueVariableId}`,
          payload
        )
        .then((response) => {
          const result = response.data;
          if (result.status === "success") {
            Swal.fire({
              icon: "success",
              title: "แก้ไขตัวแปรพื้นฐานสำเร็จ",
              showConfirmButton: false,
              timer: 1500,
            });
            $("#editBasicValueVariableModal").modal("hide");
            getBasicValueVariableReport();
          }
        })
        .catch((error) => {
          console.log(error);
          const message =
            error?.response?.data?.message ||
            error?.response?.data?.error ||
            "แก้ไขตัวแปรพื้นฐานไม่สำเร็จ";
          Swal.fire({
            icon: "error",
            title: "แก้ไขตัวแปรพื้นฐานไม่สำเร็จ",
            text: message,
          });
        });
    }

    function deleteBasicValueVariable(basicValueVariableId) {
      Swal.fire({
        title: "คุณต้องการลบตัวแปรพื้นฐานนี้หรือไม่?",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "ลบ",
        cancelButtonText: "ยกเลิก",
      }).then((result) => {
        if (result.isConfirmed) {
          axios
            .post(
              `/api/basic-value-variable/delete-basic-value-variable/${basicValueVariableId}`
            )
            .then((response) => {
              const result = response.data;
              if (result.status === "success") {
                Swal.fire({
                  icon: "success",
                  title: "ลบตัวแปรพื้นฐานสำเร็จ",
                  showConfirmButton: false,
                  timer: 1500,
                });
                getBasicValueVariableReport();
              }
            })
            .catch((error) => {
              console.log(error);
              const message =
                error?.response?.data?.message ||
                error?.response?.data?.error ||
                "ลบตัวแปรพื้นฐานไม่สำเร็จ";
              Swal.fire({
                icon: "error",
                title: "ลบตัวแปรพื้นฐานไม่สำเร็จ",
                text: message,
              });
            });
        }
      });
    }

    function redirectToLink(link) {
      window.location.href = link;
    }

    // Start Display Year
    function displayYear(year) {
      yearTable.clear();
      yearTable.rows.add(year);
      yearTable.draw();
    }
    // End Display Year

    // Start Display Year
    function displayYear(years) {
      yearTable.clear();
      years.forEach(year => {
        year.year_status,
          year.actions = `
          <center>
          <button class="btn btn-warning btn-sm" onclick="editYearModal('${year._id}')">
            <i class="fa-solid fa-pen-to-square" ></i>
          </button>
        
          <button class="btn btn-danger btn-sm" onclick="deleteYear('${year._id}')">
            <i class="fas fa-trash"></i>
          </button>
          </center>
        `;
      });
      yearTable.rows.add(years);
      yearTable.draw();
    }
    // End Display Year

    // Start Edit Year
    function editYearModal(yearId) {
      console.log("Editing year with ID:", yearId);
      axios.get(`/api/year/get-year-by-id/${yearId}`)
        .then((response) => {
          const result = response.data;
          if (result.status === "success") {
            const year = result.year;
            document.getElementById("edit_year").value = year.year;
            document.getElementById("edit-year_status").checked = year.year_status;
            $("#editYearModal").modal("show");
          }
        })
        .catch((error) => {
          console.log(error);
          Swal.fire({
            icon: "error",
            title: "ไม่สามารถดึงข้อมูลปีได้",
          });
        });

      // เพิ่ม event listener สำหรับโมดัลแก้ไข
      $("#editYearModal").on('shown.bs.modal', function () {
        document.getElementById('edit_year').focus();
      });
    }
    // End Edit Year

    // Start Delete Year
    function deleteYear(yearId) {
      // console.log(agencyId);
      Swal.fire({
        title: "คุณต้องการลบปีนี้หรือไม่?",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "ลบ",
        cancelButtonText: "ยกเลิก",
      }).then((result) => {
        if (result.isConfirmed) {
          axios
            .post(`/api/year/delete-year/${yearId}`)
            .then((response) => {
              const result = response.data;
              if (result.status === "success") {
                Swal.fire({
                  icon: "success",
                  title: "ลบปีสำเร็จ",
                  showConfirmButton: false,
                  timer: 1500,
                });
                getYearReport();
              }
            })
            .catch((error) => {
              console.log(error);
              Swal.fire({
                icon: "error",
                title: "ลบปีไม่สำเร็จ",
              });
            });
        }
      });
    }
    // End Delete Year

    // Start Update Year
    function updateYear() {
      const basicValueVariableId = document.getElementById("_id").value;
      const name = document.getElementById("edit_name").value;
      const name_eng = document.getElementById("edit_name_eng").value;
      const description = document.getElementById("edit_description").value;
      const payload = {
        name: name,
        name_eng: name_eng,
        description: description,
      };

      axios
        .post(`/api/basic-value-variable/update-basic-value-variable/${yearId}`, payload)
        .then((response) => {
          const result = response.data;
          if (result.status === "success") {
            Swal.fire({
              icon: "success",
              title: "แก้ไขตัวแปรพื้นฐานสำเร็จ",
            });
          }
        })
      // .then((response) => {
      //   const result = response.data;
      //   if (result.status === "success") {
      //     Swal.fire({
      //       icon: "success",
      //       title: "แก้ไขปีสำเร็จ",
      //       showConfirmButton: false,
      //       timer: 1500,
      //     });

      //     // ปิด modal
      //     $("#editYearModal").modal("hide");
      //     // โหลดข้อมูลใหม่
      //     getYearReport();
      //   }
      // })
      // .catch((error) => {
      //   console.log(error);
      //   Swal.fire({
      //     icon: "error",
      //     title: "แก้ไขปีไม่สำเร็จ", 
      //   });
      // });
    }
    // End Update Year
  </script>
  </body>

  </html>